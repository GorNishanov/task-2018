
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Add coroutine task type</title>
<style type="text/css">
p {text-align:justify}
li {text-align:justify}
blockquote.note
{
background-color:#E0E0E0;
padding-left: 15px;
padding-right: 15px;
padding-top: 1px;
padding-bottom: 1px;
}
ins {background-color:#A0FFA0}
del {background-color:#FFA0A0}
table {border-collapse: collapse;}
table, th, td {
border: 1px solid black;
border-collapse: collapse;
} 
</style>
</head>
<body>
<table>
<tr>
<td align="left">Doc. no.</td>
<td align="left">D1056r0</td>
</tr>
<tr>
<td align="left">Revises</td>
<td align="left">none</td>
</tr>
<tr>
<td align="left">Date:</td>
<td align="left">2018-03-23
</td>
</tr>
<!--
<tr>
<td align="left">Project:</td>
<td align="left">Programming Language C++</td>
</tr>
<tr>
<td align="left">Reference:</td>
<td align="left">ISO/IEC TS 22277, C++ Extensions for Coroutines</td>
</tr>
-->
<tr>
<td align="left">Audience:</td>
<td align="left">SG1/LEWG</td>
</tr>
<tr>
<td align="left">Reply to:</td>
<td align="left">Lewis Baker &lt;<a href="mailto:LewisBaker@gmail.com">LewisBaker@gmail.com</a>&gt;, Gor Nishanov &lt;<a href="mailto:gorn@microsoft.com">gorn@microsoft.com</a>&gt;</td>
</tr>
</table>
<h1>Add coroutine task type</h1>

<h2>Wording</h2>
Add the following sublcause to xxx
<blockquote>
<h3>XX.YY.1 Class template <code>task</code> [task]</h3>
<ol>
  <li>
    The class template <code>task</code> defines a type for a 
    <em>coroutine task object</em> that can be associated with a
    coroutine which return type is <code>task&lt;<em>T</em>&gt;</code>
    for some type <em>T</em>. In this subclause, we will refer to such a coroutine as 
    <em>task coroutine</em> and to type <em>T</em> as <em>eventual type</em>
    of a coroutine.
  </li>
  <br/>
  <li>
    The implementation shall define class template <code>task</code> and provide
    specializations of <code>coroutine_traits</code> as required to implement
    the following behavior:
    <p>
    <ol type="I">
      <li>
        A call to a task coroutine <em>f</em>
        shall return a task object <em>t</em> associated with 
        that coroutine. The called coroutine must be suspended at initial suspend point. 
        Such task object is considered to be in the <em>armed</em> state.        
      </li>
      <br>
      <li>
        Awaiting on a task object in the <em>armed</em> state as 
        if by <code>co_await<em>t</em></code> (8.3.8) shall register the
        awaiting coroutine <em>a</em> with task object <em>t</em> 
        and resume the coroutine <em>f</em>. At this point task object <em>t</em>
        is considered to be in a <em>launched</em> state.
      </li>
      <br>
      <li>
        If coroutine <em>f</em> completes due to execution of
        a <em>coroutine return statement</em> (9.6.3) or an unhandled
        exception leaving the user-authored body of the coroutine,
        awaiting coroutine <em>a</em> is resumed and a call <code>await_resume</code>
        will evaluate to the operand of <code>co_return</code> 
        statement in coroutine <em>f</em>, or an exception, respectively. 
      </li>
      <br>
      <li>
        If in the definition of the coroutine <em>g</em>, the first parameter has type
        <code>allocator_arg_t</code>, then the coroutine must have at least two arguments
        and the type of the second parameter shall satisfy the <code>Allocator</code> 
        requirements (Table 31) and if dynamic allocation required to store 
        the coroutine state (11.4.4), implementation should use provided allocator to
        allocate and deallocate the coroutine state.
      </li>
    </ol>
    </p>
  </li>
</ol>
<h4>XX.YY.2 Class template <code>task</code> synopsis [task.syn]</h4>
<!-- blockquote -->
<pre>
  template &lt;typename T&gt;
  class task {
  public:
    task(task&amp;&amp; __other) noexcept;
    ~task();
    auto operator co_await(); <i>// exposition only</i>
  private:
    coroutine_handle&lt;<em>unspecified</em>&gt; h; <i>// exposition only</i>
  };      
</pre>
<!-- /blockquote-->
</blockquote>
<h5>XX.YY.2.1 constructor</h5>
<h5>XX.YY.2.2 destructor</h5>

</body>
</html>
